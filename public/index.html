<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SSP Login</title>
<style>
body{margin:0;background:black;color:white;font-family:Arial}
#authBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
input{display:block;margin:10px;padding:8px}
button{padding:8px;margin:5px}
iframe{width:100%;height:100vh;border:none;display:none}
#adminBtn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;background:#9b59b6;color:white;border:none;border-radius:6px;display:none}
#adminPanel{position:fixed;left:10px;bottom:60px;background:#111;padding:10px;display:none;width:250px}
#chatBox{position:fixed;right:10px;bottom:10px;width:300px;background:#111;padding:10px}
#chatMessages{height:150px;overflow:auto;margin-bottom:5px}
</style>
</head>
<body>

<div id="authBox">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
</div>

<iframe id="mainFrame" src="https://sspv2play.neocities.org/home"></iframe>

<button id="adminBtn" onclick="toggleAdmin()">âš™</button>

<div id="adminPanel">
  <h3>Users</h3>
  <div id="onlineCount"></div>
  <div id="usersList"></div>
</div>

<div id="chatBox" style="display:none">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>

<script>
let currentUser=null;
let socket=null;

function signup(){
  fetch("/signup",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    username:username.value,
    password:password.value,
    email:"x"
  })}).then(r=>r.json()).then(d=>alert(d.success?"Created":"Error"));
}

function login(){
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    username:username.value,
    password:password.value
  })}).then(r=>r.json()).then(d=>{
    if(!d.success) return alert("Login failed");

    currentUser=d;
    authBox.style.display="none";
    mainFrame.style.display="block";
    chatBox.style.display="block";

    if(d.role==="admin") adminBtn.style.display="block";

    socket=new WebSocket(`wss://${location.host}`);
    socket.onopen=()=>socket.send(JSON.stringify({
      type:"join",
      username:d.username
    }));

    socket.onmessage=e=>{
      const data=JSON.parse(e.data);
      if(data.type==="chat"){
        chatMessages.innerHTML+=`<div>&lt;${data.username}&gt; ${data.message}</div>`;
      }
      if(data.type==="banned"){
        alert("You were banned");
        location.reload();
      }
    };

    chatInput.addEventListener("keypress",e=>{
      if(e.key==="Enter"){
        socket.send(JSON.stringify({
          type:"chat",
          username:d.username,
          role:d.role,
          message:chatInput.value
        }));
        chatInput.value="";
      }
    });

    loadUsers();
  });
}

function toggleAdmin(){
  adminPanel.style.display=
    adminPanel.style.display==="none"?"block":"none";
}

function loadUsers(){
  fetch("/users").then(r=>r.json()).then(d=>{
    onlineCount.innerText="Online: "+d.onlineCount;
    usersList.innerHTML="";
    d.users.forEach(u=>{
      const div=document.createElement("div");
      div.innerHTML=`${u.username} (${u.role})`;
      if(u.username!=="a"){
        const btn=document.createElement("button");
        btn.innerText=u.banned?"Unban":"Ban";
        btn.onclick=()=>{
          fetch("/"+(u.banned?"unban":"ban"),{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({username:u.username})
          }).then(loadUsers);
        };
        div.appendChild(btn);
      }
      usersList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
