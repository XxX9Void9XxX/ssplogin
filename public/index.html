<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSP Login</title>
<style>
body{margin:0;background:black;color:white;font-family:Arial}
#authBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
input{display:block;margin:10px;padding:8px}
button{padding:8px;margin:5px;cursor:pointer}
#adminPanel{position:fixed;top:10px;right:10px;background:#111;padding:10px;width:250px;display:none;border-radius:6px}
#chatBox{position:fixed;bottom:10px;right:10px;width:300px;background:#111;padding:10px;border-radius:6px;display:none}
#chatMessages{height:150px;overflow:auto;margin-bottom:5px;font-size:14px}
#coinBox{position:fixed;top:10px;left:10px;background:#111;padding:8px 12px;border-radius:6px;font-size:16px;display:none}
</style>
</head>
<body>

<div id="authBox">
  <h2>Login / Sign Up</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
  <div id="loginMsg"></div>
</div>

<div id="coinBox">Coins: <span id="coinCount">0</span></div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <div id="usersList"></div>
</div>

<div id="chatBox">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>

<script>
let currentUser = null;
let currentRole = null;
let socket = null;
let coins = 0;

function signup(){
  fetch("/signup",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:username.value,password:password.value})})
  .then(r=>r.json()).then(d=>loginMsg.innerText=d.msg);
}

function login(){
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:username.value,password:password.value})})
  .then(r=>r.json()).then(d=>{
    if(!d.success){ loginMsg.innerText=d.msg; return; }
    currentUser=d.username; currentRole=d.role;
    authBox.style.display="none";
    chatBox.style.display="block";
    coinBox.style.display="block";
    if(currentRole==="admin") adminPanel.style.display="block";
    startCoins();
    connectSocket();
    loadUsers();
  });
}

function startCoins(){
  coinCount.innerText = coins;
  setInterval(()=>{ coins+=25; coinCount.innerText=coins; },60000);
}

function connectSocket(){
  socket = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}`);
  socket.onopen = ()=>{ socket.send(JSON.stringify({type:"join",username:currentUser})); };
  socket.onmessage = e=>{
    const data=JSON.parse(e.data);
    if(data.type==="chatHistory"){ chatMessages.innerHTML=""; data.history.forEach(m=>addMessage(m.username,m.message)); }
    if(data.username){ addMessage(data.username,data.message); }
  };
  chatInput.addEventListener("keypress",e=>{
    if(e.key==="Enter" && chatInput.value.trim()!==""){
      socket.send(JSON.stringify({type:"chat",username:currentUser,message:chatInput.value}));
      chatInput.value="";
    }
  });
}

function addMessage(user,msg){ chatMessages.innerHTML+=`<div>&lt;${user}&gt; ${msg}</div>`; chatMessages.scrollTop=chatMessages.scrollHeight; }

function loadUsers(){
  if(currentRole!=="admin") return;
  fetch("/users").then(r=>r.json()).then(d=>{
    usersList.innerHTML="";
    Object.keys(d.users).forEach(u=>{
      const usr = d.users[u];
      const div = document.createElement("div");
      div.innerText = `${u} - ${usr.approved?'✅':'❌'}`;
      if(!usr.approved){
        const btn = document.createElement("button");
        btn.innerText="Approve";
        btn.onclick=()=>{ fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u})}).then(()=>loadUsers()); };
        div.appendChild(btn);
      }
      usersList.appendChild(div);
    });
  });
}
</script>
</body>
</html>
