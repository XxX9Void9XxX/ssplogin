<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SSP Login</title>
<style>
body{margin:0;background:black;color:white;font-family:Arial}
#authBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
input{display:block;margin:10px;padding:8px}
button{padding:8px;margin:5px}
iframe{width:100%;height:100vh;border:none;display:none}
#adminBtn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;background:#9b59b6;color:white;border:none;border-radius:6px;display:none;cursor:pointer}
#adminPanel{position:fixed;left:10px;bottom:60px;background:#111;padding:10px;display:none;width:260px;border-radius:6px}
#chatBox{position:fixed;right:10px;bottom:10px;width:300px;background:#111;padding:10px;border-radius:6px;display:none}
#chatMessages{height:150px;overflow:auto;margin-bottom:5px;font-size:14px}

/* ===== COINS ===== */
#coinBox{
  position:fixed;
  top:10px;
  left:10px;
  background:#111;
  padding:8px 12px;
  border-radius:6px;
  font-size:16px;
  display:none;
  z-index:9999;
}
</style>
</head>
<body>

<div id="authBox">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
</div>

<!-- COINS DISPLAY -->
<div id="coinBox">Coins: <span id="coinCount">0</span></div>

<iframe id="mainFrame" src="https://sspv2play.neocities.org/home"></iframe>

<button id="adminBtn" onclick="toggleAdmin()">âš™</button>

<div id="adminPanel">
  <h3>Users</h3>
  <div id="onlineCount"></div>
  <div id="usersList"></div>

  <button id="addCoinsBtn" style="display:none;">+100 Coins</button>
</div>

<div id="chatBox">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>

<script>
let currentUser=null;
let socket=null;
let onlineList=[];
let coinInterval=null;

/* ======================
   SIGNUP
====================== */
function signup(){
  fetch("/signup",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    username:username.value,
    password:password.value,
    email:"x"
  })}).then(r=>r.json()).then(d=>alert(d.success?"Created":"Error"));
}

/* ======================
   LOGIN
====================== */
function login(){
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    username:username.value,
    password:password.value
  })}).then(r=>r.json()).then(d=>{
    if(!d.success) return alert("Login failed");

    currentUser=d;

    authBox.style.display="none";
    mainFrame.style.display="block";
    chatBox.style.display="block";
    coinBox.style.display="block";

    // ðŸ”¥ ADMIN DETECTION (fixed + bulletproof)
    const isAdmin =
      (d.role && d.role.toLowerCase()==="admin") ||
      d.username==="a";  // protected admin username

    if(isAdmin){
      adminBtn.style.display="block";
      addCoinsBtn.style.display="block";
    }

    startCoins();
    connectSocket();
  });
}

/* ======================
   COIN SYSTEM
====================== */
function startCoins(){
  const coinKey="coins_"+currentUser.username;
  let coins=parseInt(localStorage.getItem(coinKey))||0;

  function update(){
    coinCount.innerText=coins;
    localStorage.setItem(coinKey,coins);
  }

  update();

  // +25 coins per minute
  coinInterval=setInterval(()=>{
    coins+=25;
    update();
  },60000);

  // Admin +100 button
  addCoinsBtn.onclick=()=>{
    coins+=100;
    update();
  };
}

/* ======================
   SOCKET
====================== */
function connectSocket(){
  const protocol = location.protocol === "https:" ? "wss:" : "ws:";
  socket=new WebSocket(`${protocol}//${location.host}`);

  socket.onopen=()=>{
    socket.send(JSON.stringify({
      type:"join",
      username:currentUser.username
    }));
  };

  socket.onmessage=e=>{
    const data=JSON.parse(e.data);

    if(data.type==="chatHistory"){
      chatMessages.innerHTML="";
      data.history.forEach(msg=>{
        addMessage(msg.username,msg.message);
      });
    }

    if(data.type==="chat"){
      addMessage(data.username,data.message);
    }

    if(data.type==="onlineUpdate"){
      onlineList=data.online;
      updateOnlineUI();
    }

    if(data.type==="banned"){
      alert("You were banned");
      location.reload();
    }
  };

  chatInput.addEventListener("keypress",e=>{
    if(e.key==="Enter" && chatInput.value.trim()!==""){
      socket.send(JSON.stringify({
        type:"chat",
        username:currentUser.username,
        role:currentUser.role,
        message:chatInput.value
      }));
      chatInput.value="";
    }
  });
}

/* ======================
   CHAT
====================== */
function addMessage(user,msg){
  chatMessages.innerHTML+=`<div>&lt;${user}&gt; ${msg}</div>`;
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

/* ======================
   ADMIN PANEL
====================== */
function toggleAdmin(){
  adminPanel.style.display=
    adminPanel.style.display==="none"?"block":"none";
  loadUsers();
}

function updateOnlineUI(){
  onlineCount.innerText="Online: "+onlineList.length;
  loadUsers();
}

function loadUsers(){
  fetch("/users").then(r=>r.json()).then(d=>{
    usersList.innerHTML="";

    d.users.forEach(u=>{
      const div=document.createElement("div");
      const onlineMark = onlineList.includes(u.username) ? "ðŸŸ¢" : "âš«";
      div.innerHTML=`${onlineMark} ${u.username} (${u.role})`;

      const isAdmin =
        (currentUser.role && currentUser.role.toLowerCase()==="admin") ||
        currentUser.username==="a";

      if(isAdmin && u.username!=="a"){
        const btn=document.createElement("button");
        btn.innerText=u.banned?"Unban":"Ban";
        btn.onclick = () => {
          fetch("/" + (u.banned ? "unban" : "ban"), {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({username:u.username})
          })
          .then(res => res.json())
          .then(() => {
            // refresh UI after action
            u.banned = !u.banned;        // flip banned state
            btn.innerText = u.banned ? "Unban" : "Ban";
          });
        };
        div.appendChild(btn);
      }

      usersList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
