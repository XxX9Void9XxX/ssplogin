<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SSP Login</title>
<style>
body{margin:0;background:black;color:white;font-family:Arial}
#authBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
input{display:block;margin:10px;padding:8px}
button{padding:8px;margin:5px}
iframe{border:none; display:none; width:100vw; height:100vh;}
#adminBtn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;background:#9b59b6;color:white;border:none;border-radius:6px;display:none;cursor:pointer}
#adminPanel{position:fixed;left:10px;bottom:60px;background:#111;padding:10px;display:none;width:260px;border-radius:6px}
#chatBox{position:fixed;right:10px;bottom:10px;width:300px;background:#111;padding:10px;border-radius:6px;display:none}
#chatMessages{height:150px;overflow:auto;margin-bottom:5px;font-size:14px}
#coinBox{position:fixed;top:10px;left:10px;background:#111;padding:8px 12px;border-radius:6px;font-size:16px;display:none;z-index:9999}
#addCoinsBtn{position:fixed;top:10px;left:120px;padding:8px 12px;border:none;border-radius:6px;background:#8e44ad;color:white;font-weight:bold;cursor:pointer;box-shadow:0 0 10px #9b59b6,0 0 20px #8e44ad,0 0 30px #9b59b6;animation:glow 1.5s infinite alternate;display:none;z-index:9999}
#addCoinsBtn:hover{box-shadow:0 0 20px #9b59b6,0 0 40px #8e44ad,0 0 60px #9b59b6;transform:scale(1.1);transition:all 0.2s}
.banBtn{background:#8e44ad;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;padding:4px 8px;margin-left:5px;box-shadow:0 0 8px #9b59b6,0 0 16px #8e44ad;animation:glow 1.5s infinite alternate}
.banBtn:hover{box-shadow:0 0 16px #9b59b6,0 0 32px #8e44ad;transform:scale(1.05);transition:all 0.2s}
@keyframes glow{from{box-shadow:0 0 10px #9b59b6,0 0 20px #8e44ad,0 0 30px #9b59b6;}to{box-shadow:0 0 20px #9b59b6,0 0 30px #8e44ad,0 0 40px #9b59b6;}}
</style>
</head>
<body>

<div id="authBox">
  <h2>Login / Sign Up</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <input id="email" type="email" placeholder="Email (required for signup)">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
</div>

<div id="coinBox">Coins: <span id="coinCount">0</span></div>
<button id="addCoinsBtn">+100 Coins</button>

<iframe id="mainFrame" allowfullscreen sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-presentation"></iframe>

<button id="adminBtn" onclick="toggleAdmin()">âš™</button>

<div id="adminPanel">
  <h3>Users</h3>
  <div id="onlineCount"></div>
  <div id="usersList"></div>
</div>

<div id="chatBox">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>

<script>
let currentUser=null;
let socket=null;
let onlineList=[]; 
let coinInterval=null;
let lastMessageTime=0;
let lastMessageText="";

/* ===== SIGNUP WITH EMAIL VERIFICATION ===== */
function signup(){
  const u=username.value;
  const p=password.value;
  const e=email.value;

  if(!u || !p || !e){
    alert("Fill in username, password, and email");
    return;
  }

  fetch("/send-verification",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u,password:p,email:e})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){
      alert(d.error || "Error sending verification email");
      return;
    }

    const code=prompt("Enter the 6-digit verification code sent to your email:");

    if(!code) return;

    fetch("/verify-code",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email:e,code})
    })
    .then(r=>r.json())
    .then(v=>{
      if(v.success){
        alert("Account created! You can now login.");
      } else {
        alert(v.error || "Verification failed");
      }
    });
  });
}

/* ===== LOGIN ===== */
function login(){
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username.value,password:password.value})})
  .then(r=>r.json()).then(d=>{
    if(!d.success){ if(d.banned){ alert("You have been banned"); return; } return alert("Login failed"); }
    currentUser=d;
    authBox.style.display="none";
    mainFrame.style.display="block";
    chatBox.style.display="block";
    coinBox.style.display="block";
    if(d.role && d.role.toLowerCase()==="admin"){ adminBtn.style.display="block"; addCoinsBtn.style.display="block"; }
    startCoins();
    connectSocket();
    loadFullscreenIframe();
  });
}

/* ===== COIN SYSTEM ===== */
function startCoins(){
  const coinKey="coins_"+currentUser.username;
  let coins=parseInt(localStorage.getItem(coinKey))||0;
  function update(){ coinCount.innerText=coins; localStorage.setItem(coinKey,coins); }
  update();
  coinInterval=setInterval(()=>{ coins+=25; update(); },60000);
  addCoinsBtn.onclick=()=>{ coins+=100; update(); };
}

/* ===== CHAT SOCKET ===== */
function connectSocket(){
  const protocol = location.protocol==="https:"?"wss:":"ws:";
  socket=new WebSocket(`${protocol}//${location.host}`);
  socket.onopen=()=>{ socket.send(JSON.stringify({type:"join",username:currentUser.username})); };
  socket.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==="chatHistory"){ chatMessages.innerHTML=""; data.history.forEach(m=>addMessage(m.username,m.message)); }
    if(data.type==="chat"){ addMessage(data.username,data.message); }
    if(data.type==="onlineUpdate"){ onlineList=data.online; updateOnlineUI(); }
    if(data.type==="banned"){ alert("You were banned"); location.reload(); }
  };
  chatInput.addEventListener("keypress",e=>{
    if(e.key==="Enter" && chatInput.value.trim()!==""){
      const now=Date.now();
      if(now-lastMessageTime<15000){ alert("Wait before sending another message."); return; }
      socket.send(JSON.stringify({type:"chat",username:currentUser.username,role:currentUser.role,message:chatInput.value}));
      lastMessageTime=now;
      chatInput.value="";
    }
  });
}

/* ===== CHAT DISPLAY ===== */
function addMessage(user,msg){ 
  chatMessages.innerHTML+=`<div>&lt;${user}&gt; ${msg}</div>`; 
  chatMessages.scrollTop=chatMessages.scrollHeight; 
}

/* ===== ADMIN PANEL ===== */
function toggleAdmin(){ 
  adminPanel.style.display=adminPanel.style.display==="none"?"block":"none"; 
  loadUsers(); 
}

function updateOnlineUI(){ 
  onlineCount.innerText="Online: "+onlineList.length; 
  loadUsers(); 
}

function loadUsers(){
  fetch("/users").then(r=>r.json()).then(d=>{
    usersList.innerHTML="";
    d.users.forEach(u=>{
      const div=document.createElement("div");
      const onlineMark = onlineList.includes(u.username) ? "ðŸŸ¢" : "âš«";
      div.innerHTML=`${onlineMark} ${u.username} (${u.role})`;
      usersList.appendChild(div);
    });
  });
}

/* ===== FULLSCREEN IFRAME ===== */
function loadFullscreenIframe(){
  const iframe=document.getElementById("mainFrame");
  const blankDoc=iframe.contentWindow.document;
  blankDoc.open();
  blankDoc.write(`
    <!DOCTYPE html>
    <html>
    <body style="margin:0; height:100vh; overflow:hidden;">
      <iframe src="https://sspv2play.neocities.org/home" style="border:none; width:100%; height:100%;" allowfullscreen></iframe>
    </body>
    </html>
  `);
  blankDoc.close();
}
</script>

</body>
</html>
