<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSP Login</title>
<style>
body{margin:0;background:black;color:white;font-family:Arial}
#authBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
input{display:block;margin:10px;padding:8px}
button{padding:8px;margin:5px;cursor:pointer}
iframe{width:100%;height:100vh;border:none;display:none}

/* ===== ADMIN ===== */
#adminBtn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;background:#9b59b6;color:white;border:none;border-radius:50%;display:none;cursor:pointer}
#adminPanel{position:fixed;left:10px;bottom:60px;background:#111;padding:10px;display:none;width:260px;border-radius:6px}

/* ===== CHAT ===== */
#chatBox{position:fixed;right:10px;bottom:10px;width:300px;background:#111;padding:10px;border-radius:6px;display:none;flex-direction:column}
#chatMessages{height:150px;overflow:auto;margin-bottom:5px;font-size:14px}

/* ===== COINS ===== */
#coinBox{position:fixed;top:10px;left:10px;background:#111;padding:8px 12px;border-radius:6px;font-size:16px;display:none;z-index:9999}

/* ===== ADMIN COINS BUTTON ===== */
#addCoinsBtn{position:fixed;top:10px;left:150px;background:linear-gradient(45deg,#9b59b6,#8e44ad);color:white;border:none;padding:8px 12px;border-radius:6px;box-shadow:0 0 10px #9b59b6;cursor:pointer;display:none;animation:glow 1s infinite alternate;z-index:9999}
@keyframes glow{0%{box-shadow:0 0 5px #9b59b6}100%{box-shadow:0 0 20px #9b59b6}}

/* ===== STORE BUTTON ===== */
#storeBtn{position:fixed;top:50px;left:10px;background:#222;color:white;border:1px solid #9b59b6;padding:8px 12px;border-radius:6px;cursor:pointer;display:none;z-index:9999}

/* ===== STORE ===== */
#storePanel{position:fixed;top:90px;left:10px;width:300px;background:#111;padding:10px;border-radius:6px;color:white;display:none;z-index:9999;max-height:70vh;overflow:auto}
.storeItem{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.storeItem button{padding:4px 8px;margin-left:5px}

/* ===== FULLSCREEN IFRAME ===== */
#homeFrame{width:100%;height:100vh;border:none;display:none}
</style>
</head>
<body>

<!-- ===== AUTH ===== -->
<div id="authBox">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
</div>

<!-- ===== COINS & ADMIN ===== -->
<div id="coinBox">Coins: <span id="coinCount">0</span></div>
<button id="addCoinsBtn">+100 Coins</button>
<button id="storeBtn">ðŸ›’ Store</button>

<!-- ===== ADMIN PANEL ===== -->
<button id="adminBtn" onclick="toggleAdmin()">âš™</button>
<div id="adminPanel">
  <h3>Users</h3>
  <div id="onlineCount"></div>
  <div id="usersList"></div>
</div>

<!-- ===== CHAT ===== -->
<div id="chatBox">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>

<!-- ===== HOME IFRAME ===== -->
<iframe id="homeFrame" allowfullscreen sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-presentation"></iframe>

<!-- ===== STORE PANEL ===== -->
<div id="storePanel"></div>

<script>
let currentUser=null;
let socket=null;
let onlineList=[];
let coinInterval=null;
let inventory = {};
let lastMessage = null;
let lastTime = 0;

/* ======================
   AUTH
====================== */
function signup(){
  fetch("/signup",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({username:username.value,password:password.value,email:"x"})})
  .then(r=>r.json())
  .then(d=>alert(d.success?"Created":"Error"));
}

function login(){
  fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({username:username.value,password:password.value})})
  .then(r=>r.json())
  .then(d=>{
    if(d.banned){alert("You have been banned"); return;}
    if(!d.success) return alert("Login failed");

    currentUser=d;
    authBox.style.display="none";
    homeFrame.style.display="block";
    chatBox.style.display="flex";
    coinBox.style.display="block";
    storeBtn.style.display="block";

    if(d.role==="admin") addCoinsBtn.style.display="block";
    startCoins();
    connectSocket();
    loadIframe();
    if(d.role==="admin") loadUsers();
  });
}

/* ======================
   COINS
====================== */
function startCoins(){
  const key="coins_"+currentUser.username;
  let coins=parseInt(localStorage.getItem(key))||0;

  function update(){
    coinCount.innerText=coins;
    localStorage.setItem(key,coins);
  }
  update();

  coinInterval=setInterval(()=>{coins+=25;update();},60000);

  addCoinsBtn.onclick=()=>{coins+=100;update();}
}

/* ======================
   SOCKET / CHAT
====================== */
function connectSocket(){
  const protocol = location.protocol==="https:"?"wss:":"ws:";
  socket=new WebSocket(`${protocol}//${location.host}`);
  socket.onopen=()=>socket.send(JSON.stringify({type:"join",username:currentUser.username}));

  socket.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==="chatHistory"){chatMessages.innerHTML="";data.history.forEach(m=>addMessage(m.username,m.message));}
    if(data.type==="chat") addMessage(data.username,data.message);
    if(data.type==="onlineUpdate"){onlineList=data.online;updateOnlineUI();}
    if(data.type==="banned"){alert("You were banned");location.reload();}
  };

  chatInput.addEventListener("keypress",e=>{
    if(e.key==="Enter"&&chatInput.value.trim()!==""){
      const now=Date.now();
      if(now-lastTime<15000) return;
      if(chatInput.value===lastMessage && now-lastTime<30000) return;
      lastMessage=chatInput.value;
      lastTime=now;

      socket.send(JSON.stringify({type:"chat",username:currentUser.username,role:currentUser.role,message:chatInput.value}));
      chatInput.value="";
    }
  });
}

function addMessage(user,msg){
  chatMessages.innerHTML+=`<div>&lt;${user}&gt; ${msg}</div>`;
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

/* ======================
   ADMIN PANEL
====================== */
function toggleAdmin(){
  adminPanel.style.display=adminPanel.style.display==="none"?"block":"none";
  loadUsers();
}

function updateOnlineUI(){
  onlineCount.innerText="Online: "+onlineList.length;
  loadUsers();
}

function loadUsers(){
  fetch("/users").then(r=>r.json()).then(d=>{
    usersList.innerHTML="";
    d.users.forEach(u=>{
      const div=document.createElement("div");
      const onlineMark=onlineList.includes(u.username)?"ðŸŸ¢":"âš«";
      div.innerHTML=`${onlineMark} ${u.username} (${u.role})`;
      if(currentUser.role==="admin" && u.username!=="script.add.user"){
        const btn=document.createElement("button");
        btn.innerText=u.banned?"Unban":"Ban";
        btn.onclick=()=>{
          fetch("/"+(u.banned?"unban":"ban"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u.username})})
          .then(()=>loadUsers());
        };
        div.appendChild(btn);
      }
      usersList.appendChild(div);
    });
  });
}

/* ======================
   HOME IFRAME
====================== */
function loadIframe(){
  const iframe = homeFrame;
  const doc=iframe.contentWindow.document;
  doc.open();
  doc.write(`
    <!DOCTYPE html>
    <html lang="en">
    <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>SSP Home</title></head>
    <body style="margin:0;height:100vh;overflow:hidden">
      <iframe src="https://sspv2play.neocities.org/home" style="border:none;width:100%;height:100%" allowfullscreen sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-presentation"></iframe>
    </body>
    </html>
  `);
  doc.close();
}

/* ======================
   STORE PANEL
====================== */
const items=[
  {name:"MTG Pack",cost:100,img:"https://sspv2play.neocities.org/mtg/pack.png"}
];

storeBtn.onclick=()=>{storePanel.style.display=storePanel.style.display==="none"?"block":"none";loadStore();}

function loadStore(){
  storePanel.innerHTML="";
  items.forEach(item=>{
    const div=document.createElement("div");
    div.className="storeItem";
    div.innerHTML=`<span>${item.name} - ${item.cost} coins</span>`;
    const btn=document.createElement("button");
    btn.innerText="Buy";
    btn.onclick=()=>{
      const key="coins_"+currentUser.username;
      let coins=parseInt(localStorage.getItem(key))||0;
      if(coins<item.cost){alert("Not enough coins");return;}
      coins-=item.cost;localStorage.setItem(key,coins);coinCount.innerText=coins;

      inventory[item.name]=inventory[item.name]?inventory[item.name]+1:1;
      alert(`Bought ${item.name}! You now have ${inventory[item.name]}`);
    };
    div.appendChild(btn);
    storePanel.appendChild(div);
  });
}
</script>
</body>
</html>
