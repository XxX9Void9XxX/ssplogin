let currentUser = {}; const loginPanel = document.getElementById("loginPanel"); const signupPanel = document.getElementById("signupPanel"); const authBox = document.getElementById("authBox"); const appDiv = document.getElementById("app"); const contentFrame = document.getElementById("contentFrame"); /* ---------- SWITCH PANELS ---------- */ function showSignup() { loginPanel.style.display = "none"; signupPanel.style.display = "block"; } function showLogin() { signupPanel.style.display = "none"; loginPanel.style.display = "block"; } /* ---------- LOGIN ---------- */ async function login() { const res = await fetch("/api/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username: loginUser.value, password: loginPass.value }) }); const data = await res.json(); msg.textContent = data.message || ""; if (data.success) { currentUser = data; enterApp(); } } /* ---------- SIGNUP ---------- */ async function signup() { const res = await fetch("/api/signup", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username: suUser.value, email: suEmail.value, password: suPass.value }) }); const data = await res.json(); msg2.textContent = data.message || ""; if (data.success) { currentUser = data; enterApp(); } } /* ---------- ENTER APP ---------- */ function enterApp() { authBox.style.display = "none"; appDiv.style.display = "block"; loadIframe(); } /* ---------- IFRAME ---------- */ function loadIframe() { contentFrame.style.display = "block"; contentFrame.src = "https://sspv2play.neocities.org/home"; // Wait for iframe to fully load contentFrame.onload = () => { // Only show admin panel button if the user is an admin if (currentUser.role === "admin") initAdminOverlay(); initChat(); }; } /* ---------- ADMIN PANEL ---------- */ function initAdminOverlay() { if (document.getElementById("adminBtn")) return; // avoid duplicate const btn = document.createElement("button"); btn.id = "adminBtn"; btn.textContent = "A"; btn.style.position = "fixed"; btn.style.bottom = "10px"; btn.style.left = "10px"; btn.style.width = "40px"; btn.style.height = "40px"; btn.style.fontSize = "16px"; btn.style.background = "#8e44ad"; btn.style.color = "#fff"; btn.style.border = "1px solid #fff"; btn.style.borderRadius = "50%"; // square=height, width same as height btn.style.cursor = "pointer"; btn.style.zIndex = "9999"; document.body.appendChild(btn); const panel = document.createElement("div"); panel.id = "adminPanel"; panel.style.position = "fixed"; panel.style.bottom = "60px"; panel.style.left = "10px"; panel.style.width = "320px"; panel.style.maxHeight = "400px"; panel.style.background = "rgba(0,0,0,0.95)"; panel.style.color = "#fff"; panel.style.overflowY = "auto"; panel.style.padding = "10px"; panel.style.border = "2px solid #9b59b6"; panel.style.borderRadius = "10px"; panel.style.display = "none"; panel.style.zIndex = "9999"; document.body.appendChild(panel); async function updatePanel() { const res = await fetch("/api/admin/users"); const users = await res.json(); panel.innerHTML = "<h3>Users</h3>"; const onlineCount = users.filter(u => u.online).length; const countDiv = document.createElement("div"); countDiv.textContent = Currently online: ${onlineCount}; countDiv.style.marginBottom = "6px"; panel.appendChild(countDiv); users.forEach(u => { const last = u.last_login ? new Date(u.last_login).toLocaleString() : "Never"; const line = document.createElement("div"); line.style.display = "flex"; line.style.justifyContent = "space-between"; line.style.alignItems = "center"; line.style.marginBottom = "4px"; line.innerHTML = <span>${u.username} (${u.role}) - Last: ${last}</span>; if (u.role !== "admin") { const banBtn = document.createElement("button"); banBtn.textContent = u.banned ? "Unban" : "Ban"; banBtn.style.marginLeft = "5px"; banBtn.onclick = async () => { await fetch("/api/admin/ban", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userId: u.id, banned: !u.banned }) }); u.banned = !u.banned; banBtn.textContent = u.banned ? "Unban" : "Ban"; // Immediately log out if the banned user is online if (u.username === currentUser.username && u.banned) window.location.reload(); }; line.appendChild(banBtn); } panel.appendChild(line); }); } btn.onclick = () => { panel.style.display = panel.style.display === "none" ? "block" : "none"; if (panel.style.display === "block") updatePanel(); }; setInterval(() => { if (panel.style.display === "block") updatePanel(); }, 5000); } /* ---------- CHAT ---------- */ function initChat() { if (document.getElementById("chatBox")) return; const chatBox = document.createElement("div"); chatBox.id = "chatBox"; chatBox.style.position = "fixed"; chatBox.style.bottom = "10px"; chatBox.style.right = "10px"; chatBox.style.width = "250px"; chatBox.style.height = "300px"; chatBox.style.background = "rgba(0,0,0,0.9)"; chatBox.style.color = "#fff"; chatBox.style.border = "2px solid #9b59b6"; chatBox.style.borderRadius = "10px"; chatBox.style.display = "flex"; chatBox.style.flexDirection = "column"; chatBox.style.zIndex = "9999"; document.body.appendChild(chatBox); const messagesDiv = document.createElement("div"); messagesDiv.style.flex = "1"; messagesDiv.style.overflowY = "auto"; messagesDiv.style.padding = "5px"; chatBox.appendChild(messagesDiv); const inputDiv = document.createElement("div"); inputDiv.style.display = "flex"; inputDiv.style.marginTop = "5px"; chatBox.appendChild(inputDiv); const input = document.createElement("input"); input.type = "text"; input.placeholder = "Type a message..."; input.style.flex = "1"; input.style.padding = "5px"; input.style.borderRadius = "5px"; input.style.border = "1px solid #fff"; input.style.background = "#222"; input.style.color = "#fff"; inputDiv.appendChild(input); const sendBtn = document.createElement("button"); sendBtn.textContent = "Send"; sendBtn.style.marginLeft = "5px"; sendBtn.style.borderRadius = "5px"; sendBtn.style.border = "none"; sendBtn.style.background = "#8e44ad"; sendBtn.style.color = "#fff"; sendBtn.style.cursor = "pointer"; inputDiv.appendChild(sendBtn); function fetchMessages() { fetch("/api/chat") .then(res => res.json()) .then(data => { messagesDiv.innerHTML = ""; data.forEach(m => { const p = document.createElement("div"); p.textContent = m; messagesDiv.appendChild(p); }); messagesDiv.scrollTop = messagesDiv.scrollHeight; }); } sendBtn.onclick = () => { if (input.value.trim() !== "") { const chatName = currentUser.role === "admin" ? "Admin" : currentUser.username; fetch("/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ chatName, message: input.value }) }).then(() => fetchMessages()); input.value = ""; } }; input.addEventListener("keypress", e => { if (e.key === "Enter") sendBtn.click(); }); setInterval(fetchMessages, 2000); } this is my index.js import express from "express"; import session from "express-session"; import cors from "cors"; import sqlite3 from "sqlite3"; import { WebSocketServer } from "ws"; import http from "http"; import path from "path"; import { fileURLToPath } from "url"; const __filename = fileURLToPath(import.meta.url); const __dirname = path.dirname(__filename); const app = express(); const server = http.createServer(app); const wss = new WebSocketServer({ server }); app.use(cors()); app.use(express.json()); app.use(session({ secret: "ssp-secret", resave: false, saveUninitialized: false })); app.use(express.static(path.join(__dirname, "../public"))); const db = new sqlite3.Database("./users.db"); // ===== DATABASE SETUP ===== db.serialize(() => { db.run( CREATE TABLE IF NOT EXISTS users ( id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, password TEXT, role TEXT DEFAULT 'user', banned INTEGER DEFAULT 0, lastLogin TEXT ) ); db.get("SELECT * FROM users WHERE username='a'", (err, row) => { if (!row) { db.run( "INSERT INTO users (username,password,role) VALUES ('a','a','admin')" ); } }); }); // ===== MEMORY ===== let onlineUsers = new Set(); let clients = new Map(); let chatHistory = []; // stores last 100 messages // ===== BROADCAST ONLINE USERS ===== function broadcastOnline() { const payload = JSON.stringify({ type: "onlineUpdate", online: Array.from(onlineUsers) }); wss.clients.forEach(client => { if (client.readyState === 1) { client.send(payload); } }); } // ===== SIGNUP ===== app.post("/signup", (req, res) => { const { username, password, email } = req.body; if (!username || !password || !email) return res.json({ success: false }); db.run( "INSERT INTO users (username,password) VALUES (?,?)", [username, password], err => { if (err) return res.json({ success: false }); res.json({ success: true }); } ); }); // ===== LOGIN ===== app.post("/login", (req, res) => { const { username, password } = req.body; db.get( "SELECT * FROM users WHERE username=?", [username], (err, user) => { if (!user) return res.json({ success: false }); if (user.banned) return res.json({ success: false, banned: true }); if (user.password !== password) return res.json({ success: false }); db.run( "UPDATE users SET lastLogin=? WHERE username=?", [new Date().toISOString(), username] ); onlineUsers.add(username); broadcastOnline(); res.json({ success: true, username, role: user.role }); } ); }); // ===== LOGOUT ===== app.post("/logout", (req, res) => { const { username } = req.body; onlineUsers.delete(username); broadcastOnline(); res.json({ success: true }); }); // ===== USERS LIST ===== app.get("/users", (req, res) => { db.all("SELECT username,role,banned,lastLogin FROM users", (err, rows) => { res.json({ users: rows, onlineCount: onlineUsers.size }); }); }); // ===== BAN ===== app.post("/ban", (req, res) => { const { username } = req.body; if (username === "a") return res.json({ success: false }); db.run("UPDATE users SET banned=1 WHERE username=?", [username]); onlineUsers.delete(username); if (clients.has(username)) { clients.get(username).send(JSON.stringify({ type: "banned" })); clients.get(username).close(); } broadcastOnline(); res.json({ success: true }); }); // ===== UNBAN ===== app.post("/unban", (req, res) => { const { username } = req.body; db.run("UPDATE users SET banned=0 WHERE username=?", [username]); res.json({ success: true }); }); // ===== WEBSOCKET CHAT ===== wss.on("connection", ws => { let currentUser = null; ws.on("message", message => { const data = JSON.parse(message); if (data.type === "join") { currentUser = data.username; clients.set(currentUser, ws); // SEND CHAT HISTORY ws.send(JSON.stringify({ type: "chatHistory", history: chatHistory })); broadcastOnline(); return; } if (data.type === "chat") { const chatMessage = { type: "chat", username: data.role === "admin" ? "Admin" : data.username, message: data.message }; // Store last 100 messages chatHistory.push(chatMessage); if (chatHistory.length > 100) { chatHistory.shift(); } wss.clients.forEach(client => { if (client.readyState === 1) client.send(JSON.stringify(chatMessage)); }); } }); ws.on("close", () => { if (currentUser) { onlineUsers.delete(currentUser); clients.delete(currentUser); broadcastOnline(); } }); }); app.get("*", (req, res) => { res.sendFile(path.join(__dirname, "../public/index.html")); }); const PORT = process.env.PORT || 10000; server.listen(PORT, () => console.log("SSP FULL SYSTEM running on port", PORT) );
